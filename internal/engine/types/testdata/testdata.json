{
  "owner": "",
  "name": "social_network",
  "tables": [
    {
      "name": "users",
      "columns": [
        {
          "name": "id",
          "type": "int",
          "attributes": [
            {
              "type": "primary_key"
            },
            {
              "type": "not_null"
            }
          ]
        },
        {
          "name": "username",
          "type": "text",
          "attributes": [
            {
              "type": "not_null"
            },
            {
              "type": "unique"
            },
            {
              "type": "min_length",
              "value": "5"
            },
            {
              "type": "max_length",
              "value": "32"
            }
          ]
        },
        {
          "name": "age",
          "type": "int",
          "attributes": [
            {
              "type": "not_null"
            },
            {
              "type": "min",
              "value": "13"
            },
            {
              "type": "max",
              "value": "420"
            }
          ]
        },
        {
          "name": "address",
          "type": "text",
          "attributes": [
            {
              "type": "not_null"
            },
            {
              "type": "unique"
            }
          ]
        }
      ],
      "indexes": [
        {
          "name": "age_idx",
          "columns": [
            "age"
          ],
          "type": "btree"
        }
      ]
    },
    {
      "name": "posts",
      "columns": [
        {
          "name": "id",
          "type": "int",
          "attributes": [
            {
              "type": "primary_key"
            },
            {
              "type": "not_null"
            }
          ]
        },
        {
          "name": "title",
          "type": "text",
          "attributes": [
            {
              "type": "not_null"
            },
            {
              "type": "max_length",
              "value": "300"
            }
          ]
        },
        {
          "name": "content",
          "type": "text",
          "attributes": [
            {
              "type": "not_null"
            },
            {
              "type": "max_length",
              "value": "10000"
            }
          ]
        },
        {
          "name": "author_id",
          "type": "int",
          "attributes": [
            {
              "type": "not_null"
            }
          ]
        },
        {
          "name": "post_date",
          "type": "text",
          "attributes": [
            {
              "type": "not_null"
            }
          ]
        }
      ],
      "indexes": [
        {
          "name": "author_idx",
          "columns": [
            "author_id"
          ],
          "type": "btree"
        }
      ],
      "foreign_keys": [
        {
          "child_keys": [
            "author_id"
          ],
          "parent_keys": [
            "id"
          ],
          "parent_table": "users",
          "actions": [
            {
              "on": "UPDATE",
              "do": "CASCADE"
            },
            {
              "on": "DELETE",
              "do": "CASCADE"
            }
          ]
        }
      ]
    },
    {
      "name": "likes",
      "columns": [
        {
          "name": "user_id",
          "type": "int",
          "attributes": [
            {
              "type": "not_null"
            }
          ]
        },
        {
          "name": "post_id",
          "type": "int",
          "attributes": [
            {
              "type": "not_null"
            }
          ]
        }
      ],
      "indexes": [
        {
          "name": "likes_idx",
          "columns": [
            "user_id",
            "post_id"
          ],
          "type": "primary"
        }
      ],
      "foreign_keys": [
        {
          "child_keys": [
            "user_id"
          ],
          "parent_keys": [
            "id"
          ],
          "parent_table": "users",
          "actions": [
            {
              "on": "UPDATE",
              "do": "CASCADE"
            },
            {
              "on": "DELETE",
              "do": "CASCADE"
            }
          ]
        },
        {
          "child_keys": [
            "post_id"
          ],
          "parent_keys": [
            "id"
          ],
          "parent_table": "posts",
          "actions": [
            {
              "on": "UPDATE",
              "do": "CASCADE"
            },
            {
              "on": "DELETE",
              "do": "CASCADE"
            }
          ]
        }
      ]
    },
    {
      "name": "followers",
      "columns": [
        {
          "name": "follower_id",
          "type": "int",
          "attributes": [
            {
              "type": "not_null"
            }
          ]
        },
        {
          "name": "followed_id",
          "type": "int",
          "attributes": [
            {
              "type": "not_null"
            }
          ]
        }
      ],
      "indexes": [
        {
          "name": "follower_index",
          "columns": [
            "follower_id",
            "followed_id"
          ],
          "type": "primary"
        }
      ],
      "foreign_keys": [
        {
          "child_keys": [
            "follower_id"
          ],
          "parent_keys": [
            "id"
          ],
          "parent_table": "users",
          "actions": [
            {
              "on": "UPDATE",
              "do": "CASCADE"
            },
            {
              "on": "DELETE",
              "do": "CASCADE"
            }
          ]
        },
        {
          "child_keys": [
            "followed_id"
          ],
          "parent_keys": [
            "id"
          ],
          "parent_table": "users",
          "actions": [
            {
              "on": "UPDATE",
              "do": "CASCADE"
            },
            {
              "on": "DELETE",
              "do": "CASCADE"
            }
          ]
        }
      ]
    }
  ],
  "actions": [
    {
      "name": "create_user",
      "public": true,
      "inputs": [
        "$id",
        "$username",
        "$age"
      ],
      "statements": [
        "INSERT INTO users\n    VALUES ($id, $username, $age, @caller);"
      ]
    },
    {
      "name": "update_user",
      "public": true,
      "inputs": [
        "$username",
        "$age"
      ],
      "statements": [
        "UPDATE users\n    SET username=$username, age=$age\n    WHERE address=@caller;"
      ]
    },
    {
      "name": "create_post",
      "public": true,
      "inputs": [
        "$id",
        "$title",
        "$content",
        "$date_string"
      ],
      "statements": [
        "INSERT INTO posts (id, title, content, author_id, post_date)\n    VALUES ($id, $title, $content, (\n        SELECT id\n        FROM users\n        WHERE address=@caller\n    ), $date_string);"
      ]
    },
    {
      "name": "delete_post",
      "public": true,
      "inputs": [
        "$id"
      ],
      "statements": [
        "DELETE FROM posts\n    WHERE id=$id\n    AND author_id = (\n        SELECT id\n        FROM users\n        WHERE address=@caller\n    );"
      ]
    },
    {
      "name": "like_post",
      "public": true,
      "inputs": [
        "$post_id"
      ],
      "statements": [
        "INSERT INTO likes (user_id, post_id)\n    VALUES ((\n        SELECT id\n        FROM users\n        WHERE address = @caller\n    ),\n    $post_id);"
      ]
    },
    {
      "name": "unlike_post",
      "public": true,
      "inputs": [
        "$post_id"
      ],
      "statements": [
        "DELETE FROM likes\n    WHERE post_id=$post_id\n    AND user_id = (\n        SELECT id\n        FROM users\n        WHERE address=@caller\n    );"
      ]
    },
    {
      "name": "follow",
      "public": true,
      "inputs": [
        "$username"
      ],
      "statements": [
        "INSERT INTO followers (follower_id, followed_id)\n    VALUES ((SELECT id FROM users WHERE address = @caller),\n    (SELECT id FROM users WHERE username = $username));"
      ]
    },
    {
      "name": "unfollow",
      "public": true,
      "inputs": [
        "$username"
      ],
      "statements": [
        "DELETE FROM followers\n    WHERE followers.followed_id = (SELECT id FROM users WHERE username = $username)\n    AND followers.follower_id = (SELECT id FROM users WHERE address = @caller);"
      ]
    },
    {
      "name": "get_user_by_username",
      "public": true,
      "inputs": [
        "$username"
      ],
      "statements": [
        "SELECT *\n    FROM users\n    WHERE username=$username;"
      ]
    },
    {
      "name": "get_user_by_wallet",
      "public": true,
      "inputs": [
        "$address"
      ],
      "statements": [
        "SELECT *\n    FROM users\n    WHERE address = $address;"
      ]
    },
    {
      "name": "get_feed",
      "public": true,
      "inputs": [
        "$username",
        "$offset"
      ],
      "statements": [
        "SELECT p.id, p.title, p.content, p.post_date, u.username\n    FROM posts AS p\n    INNER JOIN followers AS f ON p.author_id = f.followed_id\n    INNER JOIN users AS u ON u.id = f.followed_id\n    WHERE f.follower_id = (\n        SELECT id\n        FROM users\n        WHERE username = $username\n    )\n    ORDER BY date(u.post_date) DESC NULLS LAST\n    LIMIT 20 OFFSET $offset;"
      ]
    },
    {
      "name": "get_celebrity_feed",
      "public": true,
      "inputs": [
        "$username",
        "$offset"
      ],
      "statements": [
        "WITH popular_users AS (\n        SELECT followers.followed_id AS id, users.username AS username\n        FROM followers\n        INNER JOIN users ON users.id = followers.followed_id\n        GROUP BY followers.followed_id\n        HAVING count(followers.follower_id) \u003e= 50000\n    )\n\n    SELECT p.id, p.title, p.content, p.post_date, pu.username\n    FROM posts AS p\n    INNER JOIN popular_users AS pu ON pu.id = p.author_id\n    WHERE p.author_id IN (\n        SELECT followed_id\n        FROM followers\n        WHERE follower_id = (\n            SELECT id\n            FROM users\n            WHERE username = $username\n        )\n    )\n    ORDER BY date(p.post_date) DESC NULLS LAST\n    LIMIT 20 OFFSET $offset;"
      ]
    }
  ]
}