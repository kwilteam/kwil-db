#!/usr/bin/env sh
#
# Build docker image
#

set -eu

. ./scripts/build/.git_variables

IMAGE=${1:-"kwild"}
EXTRA=${2:-}
DOCKER_FILE="${IMAGE}.dockerfile"

test -z "${EXTRA}" || DOCKER_FILE="${IMAGE}.${EXTRA}.dockerfile"

echo Building "${IMAGE}"

BUILD_ARGS="${BUILD_ARGS:-}"
BUILD_ARGS="${BUILD_ARGS} --build-arg version=${GIT_VERSION}"
BUILD_ARGS="${BUILD_ARGS} --build-arg git_commit=${GIT_COMMIT}"
BUILD_ARGS="${BUILD_ARGS} --build-arg build_time=${BUILD_TIME}"
BUILD_ARGS="${BUILD_ARGS} --build-arg go_build_tags=${GO_BUILDTAGS:-}"

export DOCKER_BUILDKIT=1

docker build .  -t "${IMAGE}:${GIT_VERSION}" -t "${IMAGE}:latest" ${BUILD_ARGS} -f "./build/package/docker/${DOCKER_FILE}" --progress=auto
